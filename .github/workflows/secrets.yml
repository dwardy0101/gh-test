name: Encrypted Base64 Secret Transfer

on:
  workflow_dispatch:
    inputs:
      secret_token:
        description: 'Sensitive token input'
        type: string
        required: true

      secret_txt:
        description: 'Sensitive text input'
        type: string
        required: true

      secret_pass:
        description: 'Sensitive pass input'
        type: string
        required: true

jobs:
  encrypt-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Encrypt secrets and save to file
        shell: bash
        run: |
          SECRET_TOKEN=$(jq -r '.inputs.secret_token' "$GITHUB_EVENT_PATH")
          SECRET_TEXT=$(jq -r '.inputs.secret_txt' "$GITHUB_EVENT_PATH")
          SECRET_PASS=$(jq -r '.inputs.secret_pass' "$GITHUB_EVENT_PATH")

          echo "::add-mask::$SECRET_TOKEN"
          echo "::add-mask::$SECRET_TEXT"

          # Encrypt each secret
          enc() {
            echo -n "$1" | openssl enc -aes-256-cbc -pbkdf2 -salt -k "$SECRET_PASS" | base64
          }

          echo "TOKEN=$(enc "$SECRET_TOKEN")" >> encrypted.env
          echo "TXT=$(enc "$SECRET_TEXT")" >> encrypted.env

      - uses: actions/upload-artifact@v4
        with:
          name: encrypted-secrets
          path: encrypted.env

  decrypt-secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: encrypted-secrets

      - name: Decrypt secrets from file
        shell: bash
        run: |
          SECRET_PASS=$(jq -r '.inputs.secret_pass' "$GITHUB_EVENT_PATH")

          # Load key=value pairs
          while IFS='=' read -r key value; do
            if [[ -n "$key" ]]; then
              DECRYPTED=$(echo -n "$value" | base64 --decode | openssl enc -aes-256-cbc -pbkdf2 -d -salt -k "$SECRET_PASS")
              echo "$key=$DECRYPTED" >> decrypted.env
              echo "::add-mask::$DECRYPTED"
            fi
          done < encrypted.env

          echo "âœ… Secrets decrypted. Contents:"
          cat decrypted.env


# jobs:
#   # Job 1: Read a secret and encrypt
#   github-secrets:
#     runs-on: ubuntu-latest
#     name: A Job to read a secret
#     steps:
#       - id: read-secret
#         shell: bash
#         run: |
#           SECRET_TOKEN=$(jq -r '.inputs.secret_token' "$GITHUB_EVENT_PATH")
#           SECRET_PASS=$(jq -r '.inputs.secret_pass' "$GITHUB_EVENT_PATH")
#           echo "::add-mask::$SECRET_TOKEN"
#           echo "$SECRET_PASS"
          
#           BINARY_ENCRYPTED_TOKEN=$(echo -n "$SECRET_TOKEN" | openssl enc -aes-256-cbc -pbkdf2 -salt -k "$SECRET_PASS");
#           ENCRYPTED_TOKEN=$(echo -n "$BINARY_ENCRYPTED_TOKEN" | base64);
#           echo "our-token=$ENCRYPTED_TOKEN" >> $GITHUB_OUTPUT
#     outputs:
#       read-token: ${{ steps.read-secret.outputs.our-token }}

#   # Job 2: Use secret
#   use-secret:
#     needs: github-secrets
#     runs-on: ubuntu-latest
#     name: A Job to use secret
#     steps:
#     # Step 1: Decrypt the token using OpenSSL
#     - id: decrypt-token
#       shell: bash
#       run: |
#         SECRET_PASS=$(jq -r '.inputs.secret_pass' "$GITHUB_EVENT_PATH")
#         # echo "::add-mask::$SECRET_PASS"
        
#         ENCRYPTED_TOKEN=${{ needs.github-secrets.outputs.read-token }};
#         BINARY_ENCRYPTED_TOKEN=$(echo -n "$ENCRYPTED_TOKEN" | base64 --decode);
#         OUR_TOKEN=$(echo -n "$BINARY_ENCRYPTED_TOKEN" | openssl enc -aes-256-cbc -pbkdf2 -d -salt -k "$SECRET_PASS");
#         echo "our-token=$OUR_TOKEN" >> $GITHUB_OUTPUT

#     # Step 2: Print out our secret
#     - id: print-secret
#       shell: bash
#       run: echo "our-token:${{ steps.decrypt-token.outputs.our-token }}"
