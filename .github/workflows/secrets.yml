name: Encrypted Base64 Secret Transfer

on:
  workflow_dispatch:
    inputs:
      secret_token:
        description: 'Sensitive token input'
        type: string
        required: true

      secret_pass:
        description: 'Sensitive pass input'
        type: string
        required: true

jobs:
  encrypt:
    runs-on: ubuntu-latest
    steps:
      - name: Encrypt and encode secret
        run: |
          SECRET="${{ github.event.inputs.secret_token }}"
          echo "::add-mask::$SECRET"
          echo "$SECRET" > plain.txt

          # Encrypt to binary
          openssl enc -aes-256-cbc -salt \
            -in plain.txt \
            -out secret.enc \
            -pass pass:${{ github.event.inputs.secret_pass }}

          # Convert to base64 string
          base64 secret.enc > secret.b64

          # Cleanup raw files
          rm plain.txt secret.enc

      - name: Upload base64-encoded encrypted secret
        uses: actions/upload-artifact@v4
        with:
          name: b64-secret
          path: secret.b64

  decrypt:
    runs-on: ubuntu-latest
    steps:
      - name: Download base64-encoded artifact
        uses: actions/download-artifact@v4
        with:
          name: b64-secret
          path: ./secret.b64

      - name: Decode and decrypt the secret
        run: |
          # Decode base64 back to encrypted binary
          base64 -d ./secret.b64 > secret.enc

          # Decrypt to plaintext
          openssl enc -d -aes-256-cbc \
            -in secret.enc \
            -out secret.txt \
            -pass pass:${{ github.event.inputs.secret_pass }}

          # Read and mask secret
          SECRET=$(cat secret.txt)
          echo "::add-mask::$SECRET"
          echo "Decrypted secret (masked): $SECRET"

          # Clean up
          rm secret.enc secret.txt
